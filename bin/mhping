#!/usr/bin/env perl

use 5.008008;
use utf8;
use warnings FATAL => 'all';
use threads;
use threads::shared;
use Thread::Queue;
use Time::HiRes qw(time);
use Data::Dumper;

$|++;

my $VERSION = 0.001001;

my $hosts_file = $ARGV[0] or die "No hosts file specified!\n";
my @hosts = parse_hosts($hosts_file);

my @workers;
foreach my $host (@hosts) {
    my $queue = Thread::Queue->new;
    my $worker = threads->create( 'ping_host', $queue, $host );
    push( @workers, { thread => $worker, queue => $queue, host => $host } );
}
threads->create( 'show_report', \@workers )->join;

exit 0;

sub parse_hosts {
    my $hosts_file = shift;
    open( my $hosts_fh, '<', $hosts_file )
      or die "Can't open file hosts file '$hosts_file'!\n";
    my @hosts;
    while (<$hosts_fh>) {
        chomp;
        push( @hosts, $_ );
    }
    return @hosts;
}

sub show_report {
    my $workers = shift;

    my $tty_clear = qx( clear );

    while (1) {
        print $tty_clear;
        printf "%2s %-30s %10s \n", '#', 'Host', 'RTT';
        print '-' x 46, "\n";

        my $worker_count;
        foreach my $worker ( @{$workers} ) {
            my $message;
            if ( $worker->{thread}->is_running ) {
                $message = $worker->{queue}->dequeue;
                next unless $message;
                $worker_count++;
                printf "%2d %-30s %10s \n",
                  $worker_count, $worker->{host}, $message;
            }
        }

        sleep 1;
    }

    return;
}

sub ping_host {
    my $job_queue = shift;
    my $host      = shift;

    open( my $ping, '-|', "ping $host 2>&1" );
    while (<$ping>) {
        my $message;
        if (m/time=(.+)$/) {
            $message = $1;
        }
        else {
            $message = '?';
        }
        $job_queue->enqueue($message);
    }

    return;
}

# vim: set ts=4 sw=4 et:
